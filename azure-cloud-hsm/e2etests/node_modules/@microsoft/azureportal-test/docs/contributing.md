<!-- markdownlint-disable MD041 REASON: File assembled with GitDown -->

#### To enlist

git clone <https://msazure.visualstudio.com/DefaultCollection/One/_git/AzureUX-PortalFx>

#### To build the source

Use Visual Studio or Visual Studio Code to build

How to build and push your changes

1. Go to the src/msportalfx-test directory
   1. npm exec -- pnpm run clean (This will wipe out any extra files you have in the directory)
1. Build the @microsoft/azureportal-test package (see README.MD for details)
   - npm install --omit=optional
   - Note the above command pulls dependencies and builds, if you just want to build use: `npm run build`
1. Test your changes, see README.md for details on setup - [Check CI](https://aka.ms/portalfx/ci) - Alternatively run `npm test` to run tests locally

1. Push your changes

#### To setup the tests

1. To run the tests you need:

- Create a dedicated test subscription that is used for tests only
- A user that has access to the test subscription only
- An AAD App and service principal with access
- Have run `setup.cmd` in the portal repo or have run `powershell.exe -ExecutionPolicy Unrestricted -file "%~dp0\Setup-OneCloud.ps1" -DeveloperType Shell %*`

Once you have the first two use the following to create the AAD application and service principal.

```powershell
    @microsoft\azureportal-test\scripts\Create-AdAppAndServicePrincipal.ps1
        -TenantId "someguid"
        -SubscriptionId "someguid"
        -ADAppName "some ap name"
        -ADAppHomePage "https://somehomepage"
        -ADAppIdentifierUris "https://someidentiferuris"
        -ADAppPassword $someAdAppPassword
        -SPRoleDefinitionName "Reader"
```

**Note**: Don't forget to store the password you use below in key vault, secret store or other. You will not be able to retrieve it using the commandlets.

You will use the details of the created service principal in the next steps.

For more detail on [AAD Applications and Service Principals] see (<https://azure.microsoft.com/en-us/documentation/articles/resource-group-authenticate-service-principal/#authenticate-with-password---powershell>).

1. Open **test\config.json** and enter appropriate values for:

   ```json
           "aadAuthorityUrl": "https://login.windows.net/TENANT_ID_HERE",
           "aadClientId": "AAD_CLIENT_ID_HERE",
           "subscriptionId": "SUBSCRIPION_ID_HERE",
           "subscriptionName": "SUBSCRIPTION_NAME_HERE",
   ```

1. The account that corresponds to the specified credentials should have at least contributor access to the subscription specified in the **config.json** file. The account must be a Live Id account. It cannot be an account that requires two factor authentication (like most @microsoft.com accounts).

1. Install the Portal SDK from [Aux Docs](https://auxdocs.azurewebsites.net/en-us/downloads), then open Visual Studio and create a new Portal Extension from File --> New Project --> Azure Portal --> Azure Portal Extension. Name this project **LocalExtension** so that the extension itself is named LocalExtension, which is what many of the tests expect. Then hit CTRL+F5 to host the extension in IIS Express.

1. The _Can Find Grid Row_ and the _Can Choose A Spec_ tests require special configuration described in the tests themselves.

1. Many of the tests currently rely on the CloudService extension. We are working to remove this dependency.

### To run the tests

Open a command prompt in this directory and run:

```sh
 npm install --omit=optional
 npm test
```

#### Authoring documents

- When adding a document create a new \*.md file in /docs e.g /docs/foo.md
- Author the document using [markdown syntax](https://daringfireball.net/projects/markdown/syntax)
- Inject content from your documents into the master template in /docs/TEMPLATE.md using [gitdown syntax](https://github.com/gajus/gitdown) E.g
    <!-- gitdown: off -->
  ```json
  { "gitdown": "include", "file": "./foo.md" }
  ```
    <!-- gitdown: on -->
- To ensure all code samples remain up to date we extended gitdown syntax to support code injection. To reference source code in your document directly from a \*.ts file use the include-section extension E.g
    <!-- gitdown: off -->
  ```json
  {
    "gitdown": "include-section",
    "file": "../test/BrowseResourceBladeTests.ts",
    "section": "tutorial-browse-context-menu#step2"
  }
  ```
    <!-- gitdown: on -->
  This will find all content in ../test/BrowseResourceBladeTests.ts that is wrapped in comments //tutorial-browse-context-menu#step2 and will inject them directly into the document. see /docs/tutorial-browse-context-menu.md for a working example

#### Generating the docs

You can generate the documentation in one of two ways

- As part of pack the `docs` script from package.json is run to ensure that all docs are up to date

  ```sh
  npm pack
  ```

- Or, While you are writing docs you may want to check that your composition or jsdoc for API ref is generating as expected to do this you can execute run the following

  ```sh
  npm exec -- pnpm run docs
  ```

the output of the composed TEMPLATE.md will be written to ./README.md

#### To submit your contribution

Submit a pull request to the repo [https://aka.ms/portalfx/microsoft-azureportal-test/src](https://aka.ms/portalfx/microsoft-azureportal-test/src)

This project has adopted the [Microsoft Open Source Code of Conduct](https://opensource.microsoft.com/codeofconduct/). For more information see the [Code of Conduct FAQ](https://opensource.microsoft.com/codeofconduct/faq/) or contact [opencode@microsoft.com](mailto:opencode@microsoft.com) with any additional questions or comments.

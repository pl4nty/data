<!-- markdownlint-disable MD041 REASON: File assembled with GitDown -->

### Logs

By default the framework emits logs to the console. You can re-route logs to be sent to a custom Logger.

```ts
//1. import test fx
import * as testFx from '@microsoft/azureportal-test';
...
    function logToStorageAccount(logMsg: string) {
        // log to storageaccount
    }

    testFx.Logger.bind(logToStorageAccount);
```

#### Enabling diagnostic logs

You can enable additional diagnostic logs by setting the following environment variable.

> set DEBUG=testFx:warning,testFx:information,testFx:diagnostics\*

or

> set DEBUG=testFx\*

#### Flushing logs

You can capture logs and flush them as an MD file. Note that log re-routing and log flushing are completely compatible. Example of such log (styling might not be displayed correctly):

<!-- markdownlint-disable-next-line MD033 REASON: This is actually a live sample for demonstration purpose, not an attempt to bypass Markdown -->
<div style="border:inset 1px;width:900px;"><div><div class="md-log" style="box-sizing:content-box;display:flex;flex-direction:column;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;white-space:pre-wrap;width:auto"><h3 style="color:rgb(170,170,170)">Logs</h3><div class="section" style="margin:1em .5em;min-width:500px"><h4 style="color:rgb(127,127,127)">Test Case Details</h4><div class="metadata-block" style="border:1px;border-radius:.3em;border-style:inset"><div class="flex-container" style="border-collapse:collapse;display:flex;"><div class="metadata-entry metadata-key" style="border:1px;border-style:inset;word-break:break-word;padding:.4em;width:20%">Test Name</div><div class="metadata-entry metadata-value" style="border:1px;border-style:inset;word-break:break-word;padding:.4em;width:80%">Assert Tests</div></div><div class="flex-container" style="border-collapse:collapse;display:flex;"><div class="metadata-entry metadata-key" style="border:1px;border-style:inset;word-break:break-word;padding:.4em;width:20%">Test Case Name</div><div class="metadata-entry metadata-value" style="border:1px;border-style:inset;word-break:break-word;padding:.4em;width:80%">Testing assert.deepEqual with all possible signatures</div></div><div class="flex-container" style="border-collapse:collapse;display:flex;"><div class="metadata-entry metadata-key" style="border:1px;border-style:inset;word-break:break-word;padding:.4em;width:20%">Test Path</div><div class="metadata-entry metadata-value" style="border:1px;border-style:inset;word-break:break-word;padding:.4em;width:80%">src\msportalfx-test\test\AssertTests.ts</div></div></div></div><div class="section" style="margin:1em .5em;min-width:500px"><h4 style="color:rgb(127,127,127)">Error Message</h4><div class="error-block" style="background-color:black;border:2px;border-radius:.3em;border-style:inset;color:red;font-size:.9em;height:200px;overflow-y:auto;padding:.4em .7em"><div class="error-message" style="line-height:1.5em;word-break:break-word">AssertionError [ERR_ASSERTION]: Assertion failed in assert.deepEqual()</div><div class="error-message" style="line-height:1.5em;word-break:break-word">    at new AssertionError (node:internal/assert/assertion_error:467:5)</div><div class="error-message" style="line-height:1.5em;word-break:break-word">    at Object.deepEqual (D:\data\CHT\6ec83bb4\out\src\msportalfx-test\src\Utils\Assert.js:30:15)</div><div class="error-message" style="line-height:1.5em;word-break:break-word">    at async Context.&lt;anonymous&gt; (D:\data\CHT\6ec83bb4\out\src\msportalfx-test\test\AssertTests.js:55:9)</div></div></div><div class="section" style="margin:1em .5em;min-width:500px"><h4 style="color:rgb(127,127,127)">Test Case Output</h4><div class="log-block" style="border:2px;border-radius:.3em;border-style:inset;height:400px;overflow-y:auto;padding:.4em"><div class="log-entry flex-container" style="padding:.2em 0;border-collapse:collapse;display:flex;"><div class="timestamp" style="color:grey;font-size:.7em;min-width:12em">2023-06-09 21:02:52 UTC</div><div class="log-message" style="font-size:.8em;overflow-y:auto;word-break:break-word;color:red"><div> [testFx:warning] Unexpected error caught at Portal.wait: AssertionError [ERR_ASSERTION]: Expected values to be loosely deep-equal:</div><div></div><div>{</div><div>  n: 1</div><div>}</div><div></div><div>should loosely deep-equal</div><div></div><div>{</div><div>  m: 1</div><div>}</div><div>Assertion failed in assert.deepEqual()</div></div></div><div class="log-entry flex-container" style="padding:.2em 0;border-collapse:collapse;display:flex;background-color:rgba(127,127,127,.15)"><div class="timestamp" style="color:grey;font-size:.7em;min-width:12em">2023-06-09 21:02:52 UTC</div><div class="log-message" style="font-size:.8em;overflow-y:auto;word-break:break-word;"><div> [testFx:information] Test failed. Retrying...</div></div></div><div class="log-entry flex-container" style="padding:.2em 0;border-collapse:collapse;display:flex;"><div class="timestamp" style="color:grey;font-size:.7em;min-width:12em">2023-06-09 21:03:00 UTC</div><div class="log-message" style="font-size:.8em;overflow-y:auto;word-break:break-word;color:red"><div> [testFx:warning] Unexpected error caught at Portal.wait: AssertionError [ERR_ASSERTION]: Expected values to be loosely deep-equal:</div><div></div><div>{</div><div>  n: 1</div><div>}</div><div></div><div>should loosely deep-equal</div><div></div><div>{</div><div>  m: 1</div><div>}</div><div>Assertion failed in assert.deepEqual()</div></div></div></div></div></div></div></div>

The start of capturing logs and the flushing of logs is done on command to accommodate any test runner. For better partitioning of flushed logs, it is suggested to start the capture on the first try of a test case and flush the logs after the last retry. Here is an example of how to start capturing logs on the first try and flush them after the last retry in Mocha (can also be done in global hooks):

```ts
import testFx from '@microsoft/azureportal-test';
...
describe("Test Suite", function() {
    ...
    beforeEach(function() {
        const currentTest = this.currentTest;
        if (currentTest.retries() === -1 || currentTest._currentRetry === 0) {
            testFx.Logger.startLogCapture();
        }
    });

    it("Test Case", async function() {
        ...
    });

    afterEach(function() {
        const currentTest = this.currentTest;
        if (currentTest.state === "failed") {
            testFx.Logger.flushLogs(currentTest.title, { testName: currentTest.parent.title, testCaseName: currentTest.title, testPath: testPath }, error.stack ?? error.toString());
        }
    });
    ...
});
```

The function `testFx.Logger.flushLogs()` accepts 4 parameters:

1. `dirPrefix` (required) - a string with relative path to directory where the `LogSnippet.md` will be stored. The logger will create a directory `Log` inside the current working directory and then use `dirPrefix` to create relative path inside `Log`.
1. `testMetadata` (optional) - and object with a set of key-value string pairs that contains information about the test case that will be displayed in `Test Case Details` section of the log (when using default template).
1. `error` (optional) - a string that will be displayed in `Error Message` section of the log (when using default template).
1. `templatePath` (optional) - a string with path to a template that will be used by `ejs` module to generate the log file. Inside your own template, you can use objects `metadata`, `error` and `logs`. Visit [https://ejs.co/](https://ejs.co/) for more info about templates.

<!-- markdownlint-disable MD041 REASON: File assembled with GitDown -->

#### Overview

Code coverage collection is now available when using Playwright automation. Currently, code coverage is collected only on the first opened page of a browser session. The code coverage analysis is generated in a V8 format and outputted into json files per page.

#### Getting started

To collect code coverage, simply set parameters `codeCoverage` to `true` and optionally `codeCoverageOptions` in `config.json`:

```json
"codeCoverage": true,
"codeCoverageOptions": {
    "exclude": "Tests",
    "sources": "./Extension"
}
```

With parameters set as above, the code coverage will be gathered for source files located in the "Extension" directory that is relative to the current working directory and exclude any files/directories that match name "Tests".

The parameter `codeCoverageOptions` has three optional members:

1. `exclude` - A string or an array of strings that represent relative or absolute paths to files to be excluded by code coverage analysis. A path can be a direct path to a source file or it can be a directory that contains source file(s). An array of paths can be a mix of directories and direct paths to files. The "node_modules" directory is always excluded.
1. `includeJsOnly` - A flag to analyze code coverage when a `.js` file is present but its corresponding `.ts` or `.js.map` files are not. If `sources` are provided, the default is `true`. If sources are not provided, the value is always `true`.
1. `onlySources` - A flag to analyze code coverage only if a source file is found. If `sources` are provided, the default is `true`. Otherwise, the value is always `false`. If `sources` are provided and this flag is set to `false`, code coverage for most scripts that have been captured on a browser page will get analyzed and either mapped to existing source files or scripts' code will be written on disk and the analysis will get mapped to it.
1. `sources` - A string or an array of strings that represent relative or absolute paths to source files for code coverage analysis. A path can be a direct path to a `.js` file or it can be a directory that contains `.js` file(s). An array of paths can be a mix of directories and direct paths to files. If no sources are given, code coverage results for most scripts that have been captured on a browser page will be written.

The code coverage analyzer will look for `.js` and `.js.map` files inside directories passed to `codeCoverageOptions.sources` and find a corresponding `.ts` file if its present. If `.js.map` or `.ts` files are not found, the analysis will be written for `.js` file if `codeCoverageOptions.includeJsOnly` is set to `true` or that `.js` file will get ignored if `codeCoverageOptions.includeJsOnly` is set to `false`. If `.js` is not found for a script, it will be ignored if `codeCoverageOptions.onlySources` is set to `true` or written from what was served to browser if `codeCoverageOptions.onlySources` is set to `false`. Since code coverage analyzer follows the mapping described inside these files (`.js` file has information about the location of the `.js.map` file relative to itself and, in turn, `.js.map` has information about the location of the `.ts` file relative to itself), it is imperative for all those files to be present at their original locations.

If client optimizations are not explicitly turned off, the information about the scripts that run in Portal might not going to get served to the browser which may result in no code coverage to get collected. This might not be the case for side-loaded extensions.

#### Generating report

Due to a wide variety of different code coverage reporting formats, only the V8 analysis files are outputted. It is the user's responsibility to convert the code coverage analysis files into a report of choice. A recommended tool for that is [nyc](https://www.npmjs.com/package/nyc). It has capabilities to generate report in formats `lcov`, `html` and `cobertura` among others.

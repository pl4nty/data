#------------------------------------------------------------
# Copyright (c) Microsoft Corporation.  All rights reserved.
#------------------------------------------------------------

<#

.SYNOPSIS
Creates an Azure AD Application and Service Principal on a given TenantId and SubscriptionId then gives the created service principal Role definition SPRoleDefinitionName on the created application.

.PARAMETER TenantId
The Azure Tenant guid

.PARAMETER SubscriptionId
The Azure subscription guid 

.PARAMETER ADAppName
The AD application name to create
.PARAMETER ADAppHomePage
The AD App homepage uri

.PARAMETER ADAppIdentifierUris
The AD App Identifier uri

.PARAMETER ADAppPassword
The AD App Password

.PARAMETER SPRoleDefinitionName
The Role to assign the created ServicePrincipal e.g Reader, Contributior etc.

.EXAMPLE
Create-AdAppAndServicePrincipal.ps1 -TenantId "someguid" -SubscriptionId "someguid" -ADAppName "some ap name" -ADAppHomePage "https://msportalfx-test.automation.portal.azure.com" -ADAppIdentifierUris "https://msportalfx-test.automation.portal.azure.com" -ADAppPassword $someAdAppPassword -SPRoleDefinitionName "Reader"
https://azure.microsoft.com/en-us/documentation/articles/resource-group-authenticate-service-principal/ 

#>

param(
[parameter(Mandatory=$true)]
[string] $TenantId,
[parameter(Mandatory=$true)]
[string] $SubscriptionId,
[parameter(Mandatory=$true)]
[string] $ADAppName,
[parameter(Mandatory=$true)]
[string] $ADAppHomePage,
[parameter(Mandatory=$true)]
[string] $ADAppIdentifierUris,
[parameter(Mandatory=$true)]
[string] $ADAppPassword,
[parameter(Mandatory=$true)]
[string] $SPRoleDefinitionName
)

function With-Retry($Command) {
    $retryCount = 0;
    $success = $false;
    do {
        try
        {
            & $Command;
            $success = $true;
        }
        catch
        {
            if ($retryCount -gt 5) {
                throw;
            } else {
                Write-Warning "Retry of command, retryCount:$retryCount";
                Start-Sleep -s 10;
            }
            $retryCount = $retryCount + 1;
        }
    } while (!$success);
}

$ErrorActionPreference = "Stop"

Write-Output "Sign in to your account"
Login-AzureRmAccount

Select-AzureRmSubscription -TenantId $TenantId -SubscriptionId $SubscriptionId

Write-Output "Create a new Active Directory application"
$azureAdApplication = New-AzureRmADApplication -DisplayName $ADAppName -HomePage $ADAppHomePage -IdentifierUris $ADAppIdentifierUris -Password $ADAppPassword

Write-Output $azureAdApplication

Write-Output "Create a service principal for your application by passing in the application id of the Active Directory application."
With-Retry({New-AzureRmADServicePrincipal -ApplicationId $azureAdApplication.ApplicationId})

Write-Output "Grant the service principal $SPRoleDefinitionName on all resources in $SubscriptionId"
With-Retry({New-AzureRmRoleAssignment -RoleDefinitionName $SPRoleDefinitionName -ServicePrincipalName $azureAdApplication.ApplicationId.Guid})

Write-Output "AAD_CLIENTSECRET=your supplied password"
             "aadAuthorityUrl=https://login.windows.net/$TenantId"
		     "aadClientId=$($azureAdApplication.ApplicationId.Guid)"